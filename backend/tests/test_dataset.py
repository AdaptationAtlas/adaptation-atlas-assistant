import pytest

import atlas_assistant.tools.dataset
from atlas_assistant.dataset import Dataset
from atlas_assistant.settings import Settings


@pytest.mark.integration
def test_load_embeddings(settings: Settings) -> None:
    _ = settings.get_embeddings()


@pytest.mark.integration
def test_search(settings: Settings) -> None:
    search_result = atlas_assistant.tools.dataset.search(
        query="What crops are being grown in Kenya?", settings=settings
    )
    assert (
        search_result.dataset.item.id
        == "haz_exposure_cmip6_ssa_jagermeyr_historic_severe_int"
    )


def test_dataset_description(dataset: Dataset) -> None:
    # Our fixture dataset doesn't have a title
    assert (
        dataset.get_description()
        == "This dataset quantifies the historical exposure of crops and livestock to climate hazards, expressed in nominal USD value of production (VOP). It is generated by multiplying crop- or animal-specific hazard risk raster stacks by their corresponding exposure layers, The data represent hazard exposure rather than impact, showing the value of production exposed to specific hazards across administrative levels. Importantly, the dataset distinguishes between individual hazards (e.g., drought or heat alone) and compound hazard interactions (e.g., simultaneous dry and wet conditions in the same season), recognizing that a crop may show minimal exposure to a single hazard but significant exposure when multiple hazards coincide - which is often more consequential to production."
    )


def test_schema_table(dataset: Dataset) -> None:
    assert (
        dataset.get_schema_table()
        == """Name           Type    Description
-------------  ------  --------------------------------------------------------------------------
iso3           string  The ISO3 character code for the country.
admin0_name    string  The name of the country.
admin1_name    string  The name of the admin1 region (i.e. state or province).
admin2_name    string  The name of the admin2 region (i.e. city or municipality).
gaul0_code     double  The GAUL (Global Administrative Unit Layers) numeric code for the country.
gaul1_code     double  The GAUL numeric code for the admin1 region.
gaul2_code     double  The GAUL numeric code for the admin2 region.
value          double  Numeric value corresponding to the crop exposed to a specific hazard(s).
scenario       string  The SSP of the model represented in the record (always historic).
model          string  Name of the model represented in the record (always historic).
timeframe      string  The timeframe of the model represented in the record (always historic).
hazard         string  Common name of the hazard(s) represented by hazard_vars.
hazard_vars    string  The variable(s) of the hazard represented in the record.
crop           string
severity       string  The severity of the hazard represented in the record. (always severe).
exposure_var   string  The exposure variable exposed to the hazard (always vop).
exposure_unit  string  The unit of the exposure variable (always usd15)."""
    )
